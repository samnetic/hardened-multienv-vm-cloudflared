# =================================================================
# SSH Hardening Configuration
# =================================================================
# Copy to: /etc/ssh/sshd_config.d/hardening.conf
# Test: sudo sshd -t
# Apply: sudo systemctl reload sshd
# =================================================================
# IMPORTANT: Ensure SSH key access works BEFORE enabling this!
# =================================================================

# ===========================================
# AUTHENTICATION (CRITICAL)
# ===========================================

# Disable root login entirely
PermitRootLogin no

# Enable public key authentication
PubkeyAuthentication yes

# Disable password authentication (SSH keys only)
PasswordAuthentication no

# Disable empty passwords
PermitEmptyPasswords no

# Disable challenge-response authentication
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no

# ===========================================
# ACCESS CONTROL (CRITICAL)
# ===========================================

# ┌──────────────────────────────────────────────────────────────────┐
# │ CRITICAL: AllowUsers restricts SSH access to specific users     │
# │                                                                  │
# │ If using setup-vm.sh: This line is updated automatically.       │
# │ If copying manually: CHANGE the usernames below to match yours! │
# │                                                                  │
# │ Without this, ANY user with an SSH key can log in!              │
# └──────────────────────────────────────────────────────────────────┘
AllowUsers sysadmin appmgr

# Limit authentication attempts
MaxAuthTries 3

# Limit concurrent unauthenticated connections (DDoS protection)
# Format: start:rate:full - start rejecting at 10, 30% rejection at 30, 100% at 60
MaxStartups 10:30:60

# Maximum concurrent sessions per connection
MaxSessions 5

# Grace period for authentication (60 seconds)
LoginGraceTime 60

# ===========================================
# PROTOCOL & ENCRYPTION (CRITICAL)
# ===========================================

# NOTE: Protocol 2 directive removed - deprecated in OpenSSH 7.4+
# SSH-1 protocol has been removed entirely from OpenSSH

# Strong ciphers only (2024+ standard)
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com

# Strong key exchange algorithms
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512

# Strong message authentication codes
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# Host key algorithms preference
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256

# ===========================================
# SESSION MANAGEMENT
# ===========================================

# Client alive interval (5 minutes)
ClientAliveInterval 300

# Disconnect after 2 missed keep-alive signals
ClientAliveCountMax 2

# ===========================================
# SECURITY HARDENING (RECOMMENDED)
# ===========================================

# Disable X11 forwarding (not needed on servers)
X11Forwarding no

# Allow local port forwarding (-L) but block remote/dynamic forwarding (-R/-D)
# This is useful for safely accessing localhost-bound services through the SSH tunnel.
AllowTcpForwarding local

# Disable agent forwarding
AllowAgentForwarding no

# Disable user environment variables
PermitUserEnvironment no

# Disable compression (prevents CRIME attack)
Compression no

# Disable tunneling
PermitTunnel no

# Strict mode - check file permissions
StrictModes yes

# Ignore .rhosts files
IgnoreRhosts yes

# Disable host-based authentication
HostbasedAuthentication no

# ===========================================
# LOGGING (CRITICAL)
# ===========================================

# Log to AUTH facility
SyslogFacility AUTH

# Verbose logging for security events
LogLevel VERBOSE

# ===========================================
# BANNER (OPTIONAL)
# ===========================================

# Display warning banner before login
# Banner /etc/ssh/banner.txt

# Show last login time
PrintLastLog yes

# Show message of the day
PrintMotd yes
