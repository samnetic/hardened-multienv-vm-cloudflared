# =================================================================
# Caddy Reverse Proxy - Docker Compose Configuration
# =================================================================
# Modern Docker Compose v2 syntax (NO version field needed)
# Cloudflare Tunnel handles HTTPS; Caddy runs HTTP only
# =================================================================

services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    # =================================================================
    # Security Hardening (2025 Standards)
    # =================================================================
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to ports 80 and 443
    read_only: true  # Root FS is immutable; writable paths are mounted volumes
    tmpfs:
      - /tmp:size=64M,mode=1777
    pids_limit: 100

    # =================================================================
    # Resource Limits (Prevent abuse)
    # =================================================================
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # =================================================================
    # Health Check
    # =================================================================
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # =================================================================
    # Environment Variables
    # =================================================================
    environment:
      # Used if you add Cloudflare DNS plugin (optional)
      # - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}

      # Domain for configuration
      - DOMAIN=${DOMAIN:-yourdomain.com}

    # =================================================================
    # Ports (HTTP only - tunnel handles HTTPS)
    # =================================================================
    ports:
      # Bind to localhost only to prevent origin IP bypass and Docker/UFW surprises.
      - "127.0.0.1:80:80"
      # Optional: Enable if you want direct HTTPS access (not recommended with tunnel)
      # - "443:443"
      # - "443:443/udp"  # HTTP/3 (QUIC)

    # =================================================================
    # Volumes
    # =================================================================
    volumes:
      # Caddyfile (read-only)
      - ./Caddyfile:/etc/caddy/Caddyfile:ro

      # Data persistence (certificates if using HTTPS directly)
      - caddy_data:/data

      # Configuration persistence
      - caddy_config:/config

    # =================================================================
    # Networks
    # =================================================================
    networks:
      # Dedicated origin network so Caddy can reject container-to-container bypasses.
      # Cloudflared talks to Caddy via the published localhost port; the source IP
      # as seen by Caddy will be this bridge gateway (see Caddyfile tunnel_only).
      # IMPORTANT: keep this network FIRST; Docker NAT for published ports targets the
      # container IP on the first attached network (which makes remote_ip predictable).
      - caddy-origin
      - dev-web
      - staging-web
      - prod-web
      # Uncomment if you want to expose internal monitoring targets via Caddy
      # (e.g. node-exporter / docker metrics proxy in infra/monitoring-agent).
      # - monitoring

# =================================================================
# Volumes
# =================================================================
volumes:
  caddy_data:
    name: caddy_data
  caddy_config:
    name: caddy_config

# =================================================================
# Networks (External - created via scripts/create-networks.sh)
# =================================================================
networks:
  caddy-origin:
    # Create once via ./scripts/create-networks.sh (recommended).
    # This is a fixed-subnet internal network used only so Caddy can reliably
    # detect "host -> published localhost port -> container" traffic and reject
    # container-to-container bypasses.
    external: true
    name: hosting-caddy-origin
  dev-web:
    external: true
  staging-web:
    external: true
  prod-web:
    external: true
  # monitoring:
  #   external: true
