# =================================================================
# Caddyfile - HTTP Reverse Proxy for Cloudflare Tunnel
# =================================================================
# Cloudflare Tunnel handles HTTPS
# Caddy runs HTTP-only and routes traffic to apps
# =================================================================

# =================================================================
# Global Options
# =================================================================
{
  # Disable automatic HTTPS (Cloudflare Tunnel handles it)
  auto_https off

  # Disable admin API for security (comment out for debugging)
  admin off

  # Optional: Enable for Prometheus metrics
  # servers {
  #   metrics
  # }
}

# =================================================================
# Reusable Snippets
# =================================================================

(security_headers) {
  header {
    # HSTS - Force HTTPS for 1 year
    Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Prevent clickjacking
    X-Frame-Options "DENY"

    # Prevent MIME sniffing
    X-Content-Type-Options "nosniff"

    # Referrer policy
    Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions policy (restrict browser features)
    Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Hide server header
    -Server
  }
}

(proxy_headers) {
  # Preserve Cloudflare's client IP headers when behind cloudflared (remote_host is localhost).
  header_up X-Real-IP {http.request.header.CF-Connecting-IP}
  header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
  header_up X-Forwarded-Proto https  # Tell app it's behind HTTPS
  header_up X-Forwarded-Host {host}

  # Defense-in-depth: strip headers used in historical Next.js middleware bypasses.
  header_up -x-middleware-subrequest
  header_up -x-middleware-invoke
  header_up -x-middleware-next
  header_up -x-invoke-path
  header_up -x-invoke-query
  header_up -x-invoke-output
  header_up -x-invoke-status
}

# Defense-in-depth: even if Caddy is accidentally bound to a public interface,
# only accept requests coming from localhost (cloudflared on the same VM).
(tunnel_only) {
  # Defense-in-depth: only accept traffic coming from the host via the published
  # localhost port (cloudflared -> 127.0.0.1:80). Due to Docker NAT, the source
  # IP as seen inside the container becomes the bridge gateway of the dedicated
  # origin network (hosting-caddy-origin), which we pin to 10.250.0.1.
  @not_tunnel not remote_ip 127.0.0.1 ::1 10.250.0.1
  respond @not_tunnel 403
}

# =================================================================
# DEV ENVIRONMENT (Playground - for testing, can break things)
# =================================================================
# Dev apps accessible at dev-*.yourdomain.com
# Backend services (databases) can be accessed from local PC
# for local development with remote DB connections
# =================================================================

http://dev-app.yourdomain.com {
  import tunnel_only
  import security_headers

  # Reverse proxy to dev app container
  reverse_proxy app-dev:80 {
    import proxy_headers
  }

  # Access logs
  log {
    output file /data/logs/dev-access.log {
      roll_size 10mb
      roll_keep 3
    }
    format json
  }
}

# Example: Dev API
# http://dev-api.yourdomain.com {
#   import security_headers
#   reverse_proxy api-dev:3000 {
#     import proxy_headers
#   }
# }

# =================================================================
# STAGING ENVIRONMENT
# =================================================================

http://staging-app.yourdomain.com {
  import tunnel_only
  import security_headers

  # Reverse proxy to staging app container
  reverse_proxy app-staging:80 {
    import proxy_headers

    # Health check (optional)
    # health_uri /health
    # health_interval 30s
    # health_timeout 10s
  }

  # Access logs
  log {
    output file /data/logs/staging-access.log {
      roll_size 20mb
      roll_keep 5
    }
    format json
  }
}

# =================================================================
# PRODUCTION ENVIRONMENT
# =================================================================

http://app.yourdomain.com {
  import tunnel_only
  import security_headers

  # Reverse proxy to production app container
  reverse_proxy app-production:80 {
    import proxy_headers

    # Health check (optional)
    # health_uri /health
    # health_interval 30s
    # health_timeout 10s
  }

  # Access logs
  log {
    output file /data/logs/production-access.log {
      roll_size 20mb
      roll_keep 5
    }
    format json
  }
}

# =================================================================
# ADDITIONAL APPS (Examples - Uncomment as needed)
# =================================================================

# http://staging-api.yourdomain.com {
#   import security_headers
#   reverse_proxy api-staging:3000 {
#     import proxy_headers
#   }
# }

# http://api.yourdomain.com {
#   import security_headers
#   reverse_proxy api-production:3000 {
#     import proxy_headers
#   }
# }

# =================================================================
# STATIC FILE SERVER (Example)
# =================================================================
# NOTE: Caddy v2 requires explicit file_server directive!
#
# http://static.yourdomain.com {
#   import security_headers
#   root * /srv/static
#   file_server
# }

# =================================================================
# MONITORING (Netdata) - Uncomment to enable
# =================================================================
# Access server metrics, Docker stats, security events
# Recommend: Add Cloudflare Access policy to restrict access
# =================================================================

# http://monitoring.yourdomain.com {
#   import security_headers
#   reverse_proxy netdata:19999 {
#     import proxy_headers
#   }
# }

# =================================================================
# METRICS (Prometheus scrape targets) - Uncomment to enable
# =================================================================
# Recommended pattern:
# - Run exporters on the VM in an internal Docker network (infra/monitoring-agent)
# - Expose scrape endpoints via Caddy
# - Protect with Cloudflare Access (Service Auth) using service tokens
#
# Notes:
# - You must attach Caddy to the `monitoring` network in infra/reverse-proxy/compose.yml
# - Create DNS + Access apps for these hostnames (see docs/14-cloudflare-zero-trust.md)
# =================================================================

# http://metrics.yourdomain.com {
#   import tunnel_only
#   import security_headers
#   reverse_proxy node-exporter:9100 {
#     import proxy_headers
#   }
# }
#
# http://docker-metrics.yourdomain.com {
#   import tunnel_only
#   import security_headers
#   reverse_proxy dockerd-metrics-proxy:9324 {
#     import proxy_headers
#   }
# }
#
# # Optional: per-container metrics (higher privilege; see infra/monitoring-agent/compose.cadvisor.yml)
# http://cadvisor.yourdomain.com {
#   import tunnel_only
#   import security_headers
#   reverse_proxy cadvisor:8080 {
#     import proxy_headers
#   }
# }

# =================================================================
# BASE DOMAIN (No subdomain - redirect or landing page)
# =================================================================

http://yourdomain.com {
  import tunnel_only
  import security_headers

  # Option 1: Redirect to www (uncomment if preferred)
  # redir https://www.yourdomain.com{uri} permanent

  # Option 2: Show landing page
  respond "Welcome to yourdomain.com - Configure your apps at subdomains" 200
}

# =================================================================
# WILDCARD CATCH-ALL (404 for unconfigured subdomains)
# =================================================================

http://*.yourdomain.com {
  import tunnel_only
  import security_headers
  respond "This subdomain is not configured yet" 404
}
