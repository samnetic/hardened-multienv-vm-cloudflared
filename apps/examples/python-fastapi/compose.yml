# =============================================================================
# Docker Compose - FastAPI Example
# =============================================================================
# Production-ready configuration with 2025 security standards
# =============================================================================

services:
  api:
    # Security-first default: deploy pre-built images (GitOps-friendly).
    # For local/VM-side builds and loopback port publishing, use compose.local.yml.
    image: ${IMAGE:-ghcr.io/your-org/my-api:1.0.0}
    container_name: ${APP_NAME:-my-api}-${ENVIRONMENT:-production}
    restart: unless-stopped
    init: true

    # No published ports (tunnel-only threat model).
    # Expose via Caddy on the shared Docker network instead.

    # Environment variables
    environment:
      - APP_NAME=${APP_NAME:-my-api}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - PORT=8000

    # Docker networks
    networks:
      - ${DOCKER_NETWORK:-prod-web}

    # Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation

    # Drop all capabilities by default
    cap_drop:
      - ALL

    # Only add required capabilities (none needed for FastAPI)
    # cap_add:
    #   - NET_BIND_SERVICE  # Only if binding to port < 1024

    # Fork-bomb protection
    pids_limit: 200

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'      # Max 0.5 CPU cores
          memory: 512M     # Max 512MB RAM
        reservations:
          cpus: '0.1'      # Reserve 0.1 CPU cores
          memory: 128M     # Reserve 128MB RAM

    # Health check
    healthcheck:
      # Avoid depending on curl/wget being present in the image.
      test: ["CMD", "python", "-c", "import sys,urllib.request; r=urllib.request.urlopen('http://localhost:8000/health'); sys.exit(0 if getattr(r,'status',200)==200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging
    logging:
      driver: "local"
      options:
        max-size: "20m"
        max-file: "5"

# =============================================================================
# Networks
# =============================================================================

networks:
  dev-web:
    external: true
  prod-web:
    external: true
  staging-web:
    external: true

# =============================================================================
# Notes
# =============================================================================
#
# Security Features:
#   ✅ no-new-privileges - Prevents privilege escalation attacks
#   ✅ cap_drop: ALL - Drops all Linux capabilities by default
#   ✅ Resource limits - Prevents resource exhaustion attacks
#   ✅ Non-root user - Runs as UID 1000 (defined in Dockerfile)
#   ✅ Health checks - Automatic restart on failure
#   ✅ Logging limits - Prevents disk exhaustion
#
# Usage:
#   # Pre-built image:
#   sudo docker compose pull
#   sudo docker compose up -d
#
#   # Local/VM-side build (convenience only):
#   sudo docker compose -f compose.yml -f compose.local.yml up -d --build
#
#   sudo docker compose logs -f         # View logs
#   sudo docker compose ps              # Check status
#   sudo docker compose down            # Stop and remove
#   sudo docker compose restart         # Restart services
#
# =============================================================================
